<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DUSTFALL Battle Prototype</title>
    <style>
      :root {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --accent-color: #ff9800;
        --slot-win: #4caf50;
        --slot-lose: #f44336;
        --card-atk: #ff5252;
        --card-grd: #448aff;
        --card-brk: #ffeb3b;
        --card-sp: #e040fb;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        margin-bottom: 10px;
        font-size: 1.5em;
        border-bottom: 2px solid var(--accent-color);
      }

      /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
      .game-container {
        width: 100%;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .status-bar {
        display: flex;
        justify-content: space-between;
        background: #333;
        padding: 10px;
        border-radius: 8px;
        font-weight: bold;
      }

      .bar-container {
        display: flex;
        gap: 15px;
      }
      .stat-val {
        color: var(--accent-color);
      }
      .burnout {
        color: #ff0000;
        animation: flash 1s infinite;
      }

      @keyframes flash {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* ã‚¨ãƒªã‚¢å®šç¾© */
      .area {
        background: #252525;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #444;
      }

      .hand-area {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        min-height: 80px;
      }

      .enemy-hand-info {
        font-size: 0.9em;
        color: #aaa;
        text-align: center;
        margin-bottom: 5px;
      }

      /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
      .card {
        width: 80px;
        height: 110px;
        background: #444;
        border: 2px solid #666;
        border-radius: 6px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        position: relative;
        transition: transform 0.2s;
        user-select: none;
      }
      .card:hover {
        transform: translateY(-5px);
        border-color: var(--accent-color);
      }
      .card.selected {
        border-color: #fff;
        box-shadow: 0 0 10px var(--accent-color);
      }
      .card.disabled {
        opacity: 0.5;
        pointer-events: none;
        filter: grayscale(100%);
      }

      .card-cost {
        position: absolute;
        top: 5px;
        left: 5px;
        font-weight: bold;
        background: #000;
        padding: 2px 5px;
        border-radius: 4px;
        font-size: 0.8em;
      }
      .card-icon {
        font-size: 2em;
        margin: 5px 0;
      }
      .card-name {
        font-size: 0.75em;
        text-align: center;
        word-break: break-all;
      }

      /* ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—åˆ¥ã®è‰² */
      .type-Attack {
        border-bottom: 4px solid var(--card-atk);
      }
      .type-Guard {
        border-bottom: 4px solid var(--card-grd);
      }
      .type-Break {
        border-bottom: 4px solid var(--card-brk);
      }
      .type-SP {
        border-bottom: 4px solid var(--card-sp);
        border-color: var(--card-sp);
      }
      .type-Secret {
        border-bottom: 4px solid #fff;
        background: #333;
      }

      /* ã‚¹ãƒ­ãƒƒãƒˆã‚¨ãƒªã‚¢ */
      .slots-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 10px 0;
        padding: 10px;
        background: #2a2a2a;
      }
      .slot-box {
        width: 90px;
        height: 120px;
        border: 2px dashed #666;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .slot-box::after {
        content: attr(data-label);
        position: absolute;
        bottom: -25px;
        font-size: 0.8em;
        color: #888;
      }
      .slot-result {
        position: absolute;
        top: -10px;
        right: -10px;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: bold;
        z-index: 10;
      }
      .win {
        background: var(--slot-win);
        color: white;
      }
      .lose {
        background: var(--slot-lose);
        color: white;
      }
      .draw {
        background: #888;
        color: white;
      }

      /* ãƒœã‚¿ãƒ³ */
      .action-btn {
        background: var(--accent-color);
        color: #000;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        font-weight: bold;
        cursor: pointer;
        border-radius: 4px;
        margin-top: 10px;
      }
      .action-btn:disabled {
        background: #555;
        color: #888;
        cursor: not-allowed;
      }

      .counter-btn {
        background: #9c27b0;
        color: white;
        width: 100%;
        margin-bottom: 5px;
      }

      /* ãƒ­ã‚° */
      #battle-log {
        height: 150px;
        overflow-y: auto;
        background: #111;
        padding: 10px;
        font-family: monospace;
        font-size: 0.9em;
        border: 1px solid #333;
      }
      .log-turn {
        color: var(--accent-color);
        border-bottom: 1px solid #333;
        margin-top: 5px;
      }
      .log-dmg {
        color: #ff5252;
      }
      .log-sys {
        color: #448aff;
      }
    </style>
  </head>
  <body>
    <h1>DUSTFALL - Test Battle System</h1>

    <div class="game-container">
      <div class="area">
        <div class="status-bar">
          <span>ENEMY (AI)</span>
          <div class="bar-container">
            <span>HP: <span id="e-hp" class="stat-val">100</span></span>
            <span>Pos: <span id="e-pos" class="stat-val">100</span></span>
            <span>EP: <span id="e-ep" class="stat-val">7</span></span>
            <span>SP: <span id="e-sp" class="stat-val">0</span></span>
          </div>
        </div>
        <div
          id="e-burnout-msg"
          style="display: none; color: red; font-size: 0.8em"
        >
          âš ï¸ BURNOUT âš ï¸
        </div>

        <p class="enemy-hand-info">â–¼ æ•µã®æ‰‹æœ­æƒ…å ± (å…¬é–‹) â–¼</p>
        <div class="hand-area" id="enemy-hand-display"></div>
      </div>

      <div class="area" style="text-align: center">
        <div id="phase-display">PHASE 1: æº–å‚™</div>
        <div class="slots-container">
          <div class="slot-box" id="e-slot1" data-label="Enemy Slot 1"></div>
          <div class="slot-box" id="e-slot2" data-label="Enemy Slot 2"></div>
        </div>
        <div style="font-weight: bold; margin: 5px">VS</div>
        <div class="slots-container">
          <div class="slot-box" id="p-slot1" data-label="Player Slot 1"></div>
          <div class="slot-box" id="p-slot2" data-label="Player Slot 2"></div>
        </div>
      </div>

      <div id="battle-log"></div>

      <div class="area">
        <div class="status-bar">
          <span>PLAYER</span>
          <div class="bar-container">
            <span>HP: <span id="p-hp" class="stat-val">100</span></span>
            <span>Pos: <span id="p-pos" class="stat-val">100</span></span>
            <span>EP: <span id="p-ep" class="stat-val">7</span></span>
            <span>SP: <span id="p-sp" class="stat-val">0</span></span>
          </div>
        </div>
        <div
          id="p-burnout-msg"
          style="display: none; color: red; font-size: 0.8em"
        >
          âš ï¸ BURNOUT (é˜²å¾¡ä¸å¯ / è¢«ãƒ€ãƒ¡1.5å€) âš ï¸
        </div>

        <div style="margin-top: 10px">
          <p>æ‰‹æœ­ã‚’é¸æŠ (æ®‹ã‚ŠEPå†…ã§2æšé¸æŠ)</p>
          <div class="hand-area" id="player-hand-display"></div>

          <div style="display: flex; gap: 10px; margin-top: 15px">
            <div
              id="secret-slot"
              class="card type-Secret"
              style="height: 90px; width: 70px"
            >
              <div class="card-icon">ğŸ”’</div>
              <div class="card-name">Secret</div>
            </div>
            <div style="flex-grow: 1">
              <button
                id="btn-counter"
                class="action-btn counter-btn"
                onclick="toggleCounter()"
              >
                âš ï¸ SP Counter (Wait)
              </button>
              <button
                id="btn-decide"
                class="action-btn"
                style="width: 100%"
                onclick="commitTurn()"
              >
                ã‚¿ãƒ¼ãƒ³é–‹å§‹ (DECIDE)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /**
       * DUSTFALL Battle Logic
       * ä»•æ§˜æ›¸ã«åŸºã¥ãå®Ÿè£…
       */

      // --- å®šæ•°ãƒ»è¨­å®š ---
      const TYPES = {
        ATTACK: "Attack",
        GUARD: "Guard",
        BREAK: "Break",
        SP: "SP",
      };

      const ICONS = {
        Attack: "âš”ï¸",
        Guard: "ğŸ›¡ï¸",
        Break: "ğŸ’¥",
        SP: "ğŸŒŸ",
        Secret: "ğŸ”’",
      };

      // 3ã™ãã¿ãƒ­ã‚¸ãƒƒã‚¯: keyãŒvalueã«å‹ã¤
      const ADVANTAGE = {
        Attack: "Break",
        Break: "Guard",
        Guard: "Attack",
      };

      // ãƒ€ãƒ¡ãƒ¼ã‚¸ä¿‚æ•° (ä»®å®šå€¤)
      const DMG = {
        LIGHT: 10,
        MEDIUM: 20,
        HEAVY: 30,
        SP: 50,
      };

      // --- ã‚¯ãƒ©ã‚¹å®šç¾© ---

      class Card {
        constructor(id, type, cost, name, isSecret = false) {
          this.id = id;
          this.type = type;
          this.cost = cost;
          this.name = name;
          this.isSecret = isSecret;
        }
      }

      class Fighter {
        constructor(name, isPlayer) {
          this.name = name;
          this.isPlayer = isPlayer;
          this.hp = 100;
          this.posture = 100;
          this.ep = 7;
          this.sp = 0;
          this.maxEp = 7;
          this.maxSp = 5;
          this.isBurnout = false;

          this.deck = [];
          this.hand = [];
          this.secretCard = null;

          // ã‚¹ãƒ­ãƒƒãƒˆé¸æŠç”¨
          this.selectedCards = [null, null];
          this.useCounter = false; // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚³ãƒãƒ³ãƒ‰ä½¿ç”¨ãƒ•ãƒ©ã‚°

          this.initDeck();
        }

        initDeck() {
          // åŸºæœ¬ãƒ‡ãƒƒã‚­æ§‹æˆ (ä»•æ§˜æ›¸ã®æ­¦å™¨ãƒ»é˜²å…·ãƒ»ã‚¢ãƒ“ãƒªãƒ†ã‚£æ§‹æˆã‚’æ¨¡å€£)
          const templates = [
            { t: TYPES.ATTACK, c: 2, n: "é€Ÿæ–¬ã‚Š" },
            { t: TYPES.ATTACK, c: 2, n: "é€Ÿæ–¬ã‚Š" },
            { t: TYPES.ATTACK, c: 3, n: "å¼·æ’ƒ" }, // ã‚¢ãƒ¼ãƒãƒ¼ç‹™ã„
            { t: TYPES.BREAK, c: 2, n: "è¹´ã‚Š" },
            { t: TYPES.BREAK, c: 3, n: "ã‚·ãƒ¼ãƒ«ãƒ‰ãƒãƒƒã‚·ãƒ¥" },
            { t: TYPES.GUARD, c: 1, n: "é˜²å¾¡" },
            { t: TYPES.GUARD, c: 1, n: "é˜²å¾¡" },
            { t: TYPES.GUARD, c: 2, n: "ãƒ‘ãƒªã‚£" },
            { t: TYPES.SP, c: 5, n: "å¥¥ç¾©" }, // SPæŠ€
          ];

          let idCounter = 0;
          templates.forEach((tpl) => {
            this.deck.push(
              new Card(`${this.name}_${idCounter++}`, tpl.t, tpl.c, tpl.n)
            );
          });

          // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
          this.deck.sort(() => Math.random() - 0.5);

          // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã‚’1æšæŠœã
          this.secretCard = this.deck.pop();
          this.secretCard.isSecret = true;
        }

        drawHand() {
          // æ‰‹æœ­ãŒ4æšã«ãªã‚‹ã¾ã§è£œå……
          while (this.hand.length < 4 && this.deck.length > 0) {
            this.hand.push(this.deck.pop());
          }
          // ãƒ‡ãƒƒã‚­åˆ‡ã‚Œãªã‚‰æ¨ã¦æœ­ã‹ã‚‰æˆ»ã™å‡¦ç†ãŒå¿…è¦ã ãŒä»Šå›ã¯çœç•¥(ãƒ†ã‚¹ãƒˆç‰ˆã®ãŸã‚)
          if (this.hand.length < 4) {
            log(`${this.name}ã®å±±æœ­ãŒå°½ãã¾ã—ãŸã€‚`);
          }
        }

        // EPå›å¾©ã¨ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆè§£é™¤
        startTurn() {
          if (this.isBurnout) {
            log(`${this.name}ã¯ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆã‹ã‚‰å¾©å¸°ã—ãŸï¼`);
            this.isBurnout = false;
          }

          this.ep = Math.min(this.ep + 3, this.maxEp);
          this.sp = Math.min(this.sp + 1, this.maxSp);

          this.selectedCards = [null, null];
          this.useCounter = false;
          this.drawHand();
        }
      }

      // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
      let player = new Fighter("Player", true);
      let enemy = new Fighter("Enemy", false);
      let turnCount = 1;

      // UIè¦ç´ 
      const uiLog = document.getElementById("battle-log");

      // --- ã‚²ãƒ¼ãƒ é€²è¡Œãƒ­ã‚¸ãƒƒã‚¯ ---

      function initGame() {
        log("=== DUSTFALL BATTLE START ===");
        player.drawHand();
        enemy.drawHand();
        updateUI();
      }

      function log(msg, type = "") {
        const div = document.createElement("div");
        div.innerHTML = msg;
        if (type) div.className = type;
        uiLog.appendChild(div);
        uiLog.scrollTop = uiLog.scrollHeight;
      }

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚«ãƒ¼ãƒ‰é¸æŠå‡¦ç†
      function selectCard(index) {
        const card = player.hand[index];

        // ã‚¬ãƒ¼ãƒ‰åˆ¶é™ (ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆæ™‚)
        if (player.isBurnout && card.type === TYPES.GUARD) {
          alert("ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆä¸­ã¯ã‚¬ãƒ¼ãƒ‰ã‚’é¸æŠã§ãã¾ã›ã‚“ï¼");
          return;
        }

        // SPåˆ¶é™
        if (card.type === TYPES.SP && player.sp < 5) {
          alert("SPã‚²ãƒ¼ã‚¸ãŒæœ€å¤§ã§ãªã„ãŸã‚SPæŠ€ã¯ä½¿ãˆã¾ã›ã‚“ã€‚");
          return;
        }

        // é¸æŠãƒˆã‚°ãƒ«
        const slot1 = player.selectedCards[0];
        const slot2 = player.selectedCards[1];

        // ã™ã§ã«é¸æŠæ¸ˆã¿ãªã‚‰è§£é™¤
        if (slot1 === card) {
          player.selectedCards[0] = null;
        } else if (slot2 === card) {
          player.selectedCards[1] = null;
        } else {
          // ç©ºãã‚¹ãƒ­ãƒƒãƒˆã«å…¥ã‚Œã‚‹
          if (!slot1) player.selectedCards[0] = card;
          else if (!slot2) player.selectedCards[1] = card;
        }

        updateUI();
      }

      // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é¸æŠ
      function selectSecret() {
        if (!player.secretCard) return;
        // æ‰‹æœ­ã®ç©ºããŒã‚ã‚‹ã‹ã€å…¥ã‚Œæ›¿ãˆãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã ãŒ
        // ç°¡æ˜“çš„ã«ã€Œç¬¬5ã®æ‰‹æœ­ã€ã¨ã—ã¦é¸æŠå€™è£œã«å…¥ã‚Œã‚‹å®Ÿè£…

        const card = player.secretCard;
        // SP/Burnoutãƒã‚§ãƒƒã‚¯ã¯åŒæ§˜
        if (player.isBurnout && card.type === TYPES.GUARD) {
          alert("ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆä¸­ã‚¬ãƒ¼ãƒ‰ä¸å¯");
          return;
        }
        if (card.type === TYPES.SP && player.sp < 5) {
          alert("SPä¸è¶³");
          return;
        }

        const slot1 = player.selectedCards[0];
        const slot2 = player.selectedCards[1];

        if (slot1 === card) player.selectedCards[0] = null;
        else if (slot2 === card) player.selectedCards[1] = null;
        else {
          if (!slot1) player.selectedCards[0] = card;
          else if (!slot2) player.selectedCards[1] = card;
        }
        updateUI();
      }

      // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒœã‚¿ãƒ³
      function toggleCounter() {
        // 1è©¦åˆã«1å›ãªã©ã®åˆ¶é™ãŒã‚ã‚‹ãŒã€ãƒ†ã‚¹ãƒˆç‰ˆãªã®ã§EPã‚³ã‚¹ãƒˆãªã—ãƒ»å›æ•°åˆ¶é™ãªã—ã§ãƒˆã‚°ãƒ«ã®ã¿å®Ÿè£…
        // ä»•æ§˜æ›¸ã§ã¯ã€Œåˆ¥æ ã®ã‚³ãƒãƒ³ãƒ‰ã€ã€‚ã“ã“ã§ã¯ã€Œè¡Œå‹•ã—ãªã„ä»£ã‚ã‚Šã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¾…æ©Ÿã€ã¨è§£é‡ˆã™ã‚‹ã‹ã€
        // ã€Œè¿½åŠ ã§ã‚»ãƒƒãƒˆã€ã‹ã€‚ä»•æ§˜æ›¸ã€Œç‰‡æ–¹ãŒSPã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚¿ãƒ¼ãƒ³ã«ç›¸æ‰‹ãŒã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨ã—ãŸå ´åˆã¯åŠ¹æœãŒç›¸æ®ºã€
        // ã“ã“ã§ã¯ã€Œã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã€ã‚’ONã«ã™ã‚‹ã¨ã€ã‚¹ãƒ­ãƒƒãƒˆé¸æŠã«é–¢ã‚ã‚‰ãšSPæ‰“ã¡æ¶ˆã—ãŒç™ºå‹•ã™ã‚‹ã¨ã™ã‚‹ã€‚

        // â€»ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ãƒ•ãƒ©ã‚°ã ã‘ç«‹ã¦ã‚‹
        player.useCounter = !player.useCounter;
        const btn = document.getElementById("btn-counter");
        btn.style.background = player.useCounter ? "#e91e63" : "#9c27b0";
        btn.innerText = player.useCounter
          ? "âš ï¸ Counter READY"
          : "âš ï¸ SP Counter (Wait)";
      }

      // AIãƒ­ã‚¸ãƒƒã‚¯ (ç°¡æ˜“ç‰ˆ: ãƒ©ãƒ³ãƒ€ãƒ  + å¤šå°‘ã®è³¢ã•)
      function aiDecide() {
        enemy.selectedCards = [null, null];
        enemy.useCounter = false;

        // æ‰‹æœ­ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
        let availableHand = [...enemy.hand];
        if (enemy.secretCard) availableHand.push(enemy.secretCard);

        // ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆæ™‚ã¯ã‚¬ãƒ¼ãƒ‰é™¤å¤–
        if (enemy.isBurnout) {
          availableHand = availableHand.filter((c) => c.type !== TYPES.GUARD);
        }

        // ã‚³ã‚¹ãƒˆè¨ˆç®—ç”¨
        let currentEp = enemy.ep;

        // ã‚¹ãƒ­ãƒƒãƒˆ1é¸æŠ
        if (availableHand.length > 0) {
          // é©å½“ã«é¸ã¶ (å°†æ¥çš„ã«ã¯ã“ã“ã‚’æ€§æ ¼ã‚¿ã‚¤ãƒ—ã§åˆ†å²)
          let idx = Math.floor(Math.random() * availableHand.length);
          let card1 = availableHand[idx];

          // EPãƒã‚§ãƒƒã‚¯
          if (card1.cost <= currentEp) {
            // SPãƒã‚§ãƒƒã‚¯
            if (card1.type === TYPES.SP && enemy.sp < 5) {
              // SPä¸è¶³ãªã‚‰åˆ¥ã®ã‚’æ¢ã™(ç°¡æ˜“å‡¦ç†: ã‚¹ã‚­ãƒƒãƒ—)
            } else {
              enemy.selectedCards[0] = card1;
              currentEp -= card1.cost;
              availableHand.splice(idx, 1);
            }
          }
        }

        // ã‚¹ãƒ­ãƒƒãƒˆ2é¸æŠ
        if (availableHand.length > 0 && enemy.selectedCards[0]) {
          let idx = Math.floor(Math.random() * availableHand.length);
          let card2 = availableHand[idx];
          if (card2.cost <= currentEp) {
            if (card2.type === TYPES.SP && enemy.sp < 5) {
            } else {
              enemy.selectedCards[1] = card2;
            }
          }
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒSPæ’ƒã¡ãã†ãªã‚‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ (ç°¡æ˜“ç¢ºç‡)
        if (player.sp === 5 && Math.random() > 0.5) {
          enemy.useCounter = true;
          log("æ•µã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®æ§‹ãˆã‚’ã¨ã£ã¦ã„ã‚‹...", "log-sys");
        }
      }

      // ã‚¿ãƒ¼ãƒ³å®Ÿè¡Œ (ã‚³ãƒŸãƒƒãƒˆ)
      function commitTurn() {
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¥åŠ›ãƒã‚§ãƒƒã‚¯
        if (!player.selectedCards[0] || !player.selectedCards[1]) {
          alert("ã‚«ãƒ¼ãƒ‰ã‚’2æšé¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        const totalCost =
          player.selectedCards[0].cost + player.selectedCards[1].cost;
        if (totalCost > player.ep) {
          alert(`EPãŒè¶³ã‚Šã¾ã›ã‚“ (å¿…è¦: ${totalCost}, ç¾åœ¨: ${player.ep})`);
          return;
        }

        // AIæ±ºå®š
        aiDecide();
        // AIã‚‚ã‚«ãƒ¼ãƒ‰æœªé¸æŠã«ãªã‚‹å ´åˆãŒã‚ã‚‹(EPä¸è¶³ç­‰)ã®ã§ã€nullã®å ´åˆã¯Waitæ‰±ã„(Cost0)ã«ã™ã‚‹å‡¦ç†ãŒå¿…è¦ã ãŒã€
        // ä»Šå›ã¯å¿…ãšé¸ã°ã‚Œã‚‹å‰æã‹ã€é¸ã°ã‚Œãªã‹ã£ãŸã‚‰ã€Œä½•ã‚‚ã—ãªã„(Cost0)ã€ã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹
        if (!enemy.selectedCards[0])
          enemy.selectedCards[0] = new Card("wait", "Wait", 0, "æ§˜å­è¦‹");
        if (!enemy.selectedCards[1])
          enemy.selectedCards[1] = new Card("wait", "Wait", 0, "æ§˜å­è¦‹");

        // å‡¦ç†é–‹å§‹
        log(`<div class="log-turn">Turn ${turnCount} Execution</div>`);

        // EPæ¶ˆè²»
        player.ep -= totalCost;
        if (
          player.selectedCards[0].type === TYPES.SP ||
          player.selectedCards[1].type === TYPES.SP
        )
          player.ep -= 5; // SPæŠ€ã¯EP5æ¶ˆè²»ã¨ä»•æ§˜ã«ã‚ã‚‹ãŒã‚³ã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿä»•æ§˜æ›¸ã€ŒSPæŠ€...EPã‚’åŒæ™‚ã«5æ¶ˆè²»ã€ã€‚ã“ã“ã§ã¯ã‚«ãƒ¼ãƒ‰ã‚³ã‚¹ãƒˆè‡ªä½“ã‚’5ã«è¨­å®šã—ã¦ã„ã‚‹ã®ã§äºŒé‡å¼•ãè½ã¨ã—ã—ãªã„ã‚ˆã†ã«æ³¨æ„ã€‚ã‚«ãƒ¼ãƒ‰å®šç¾©ã§Cost5ã«ã—ã¦ã‚ã‚‹ã®ã§OKã€‚

        const eTotalCost =
          enemy.selectedCards[0].cost + enemy.selectedCards[1].cost;
        enemy.ep -= eTotalCost;

        // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½¿ç”¨ãƒã‚§ãƒƒã‚¯ -> ä½¿ç”¨ã—ãŸã‚‰ãƒ‡ãƒƒã‚­ã‹ã‚‰è£œå……
        [player, enemy].forEach((fighter) => {
          fighter.selectedCards.forEach((card) => {
            if (card && card.isSecret) {
              // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½¿ç”¨æ¸ˆã¿ã€‚æ–°ãŸãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’å¼•ã(å±±æœ­ã‹ã‚‰)
              log(
                `${fighter.name}ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€${card.name}ã€‘ã‚’ä½¿ç”¨ã—ãŸï¼`
              );
              if (fighter.deck.length > 0) {
                fighter.secretCard = fighter.deck.pop();
                fighter.secretCard.isSecret = true;
              } else {
                fighter.secretCard = null;
              }
            }
          });
          // æ‰‹æœ­ã‹ã‚‰ä½¿ç”¨ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’é™¤å»
          fighter.hand = fighter.hand.filter(
            (c) => !fighter.selectedCards.includes(c)
          );
        });

        // æˆ¦é—˜è§£æ±º
        resolveBattle();
      }

      function resolveBattle() {
        // ã‚¹ãƒ­ãƒƒãƒˆ1
        log("<b>--- Slot 1 ---</b>");
        const r1 = compareSlots(
          player.selectedCards[0],
          enemy.selectedCards[0],
          1
        );
        renderSlotResult(1, r1);

        // ã‚¹ãƒ­ãƒƒãƒˆ2 (ã‚¹ãƒ­ãƒƒãƒˆ1ã®çµæœãƒãƒ•/ãƒ‡ãƒãƒ•ã‚’è€ƒæ…®ã™ã¹ãã ãŒã€ä»Šå›ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«åˆ¤å®š)
        // ä»•æ§˜: å‹åˆ©å´ã¯ã‚¹ãƒ­ãƒƒãƒˆ2åŠ¹æœä¸Šæ˜‡ã€æ•—åŒ—å´ã¯ã‚¹ãƒ­ãƒƒãƒˆ2åŠ¹æœæ¸›å°‘
        // ç°¡æ˜“å®Ÿè£…: å‹è€…ã®ã‚¹ãƒ­ãƒƒãƒˆ2ã®å¨åŠ›ã‚’1.5å€ã€æ•—è€…ã®ã‚¹ãƒ­ãƒƒãƒˆ2ã‚’0.5å€è¨ˆç®—ã«ã™ã‚‹ç­‰ã®ãƒ•ãƒ©ã‚°ã‚’æ¸¡ã™

        let pMod = 1.0;
        let eMod = 1.0;

        if (r1.winner === "player") {
          pMod = 1.5;
          eMod = 0.5;
          log(">> Player Slot1å‹åˆ©ãƒœãƒ¼ãƒŠã‚¹: æ¬¡ã®æ‰‹å¨åŠ›UP!");
        }
        if (r1.winner === "enemy") {
          eMod = 1.5;
          pMod = 0.5;
          log(">> Enemy Slot1å‹åˆ©ãƒœãƒ¼ãƒŠã‚¹: æ¬¡ã®æ‰‹å¨åŠ›UP!");
        }

        log("<b>--- Slot 2 ---</b>");
        const r2 = compareSlots(
          player.selectedCards[1],
          enemy.selectedCards[1],
          2,
          pMod,
          eMod
        );
        renderSlotResult(2, r2);

        // ã‚¿ãƒ¼ãƒ³çµ‚äº†å‡¦ç†
        endTurnProcess();
      }

      function compareSlots(pCard, eCard, slotNum, pMod = 1.0, eMod = 1.0) {
        let result = { winner: "draw", msg: "" };

        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼/SPåˆ¤å®š
        // ä»•æ§˜: SP vs Counter -> SPç„¡åŠ¹åŒ–
        let pIsSP = pCard.type === TYPES.SP;
        let eIsSP = eCard.type === TYPES.SP;

        if (pIsSP && enemy.useCounter) {
          log(
            `Enemyã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ Playerã®${pCard.name}ã¯ç„¡åŠ¹åŒ–ã•ã‚ŒãŸï¼`,
            "log-sys"
          );
          pCard = new Card("cancelled", "Wait", 0, "ç„¡åŠ¹"); // ãƒ€ãƒŸãƒ¼åŒ–
        }
        if (eIsSP && player.useCounter) {
          log(
            `Playerã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼ Enemyã®${eCard.name}ã¯ç„¡åŠ¹åŒ–ã•ã‚ŒãŸï¼`,
            "log-sys"
          );
          eCard = new Card("cancelled", "Wait", 0, "ç„¡åŠ¹");
        }

        // 3ã™ãã¿åˆ¤å®š
        // Waitã¯å…¨ã¦ã®å±æ€§ã«è² ã‘ã‚‹ã¨ä»®å®šã€ã‚ã‚‹ã„ã¯åˆ¤å®šãªã—
        if (pCard.type === "Wait" && eCard.type === "Wait")
          return { winner: "draw" };
        if (pCard.type === "Wait")
          return applyDamage(enemy, player, eCard, eMod, "ä¸€æ–¹çš„æ”»æ’ƒ");
        if (eCard.type === "Wait")
          return applyDamage(player, enemy, pCard, pMod, "ä¸€æ–¹çš„æ”»æ’ƒ");

        let pWinType = ADVANTAGE[pCard.type] === eCard.type;
        let eWinType = ADVANTAGE[eCard.type] === pCard.type;

        // çµæœåˆ¤å®š
        if (pWinType) {
          return applyDamage(player, enemy, pCard, pMod, "å±æ€§å‹åˆ©");
        } else if (eWinType) {
          return applyDamage(enemy, player, eCard, eMod, "å±æ€§å‹åˆ©");
        } else {
          // ã‚ã„ã“ -> ã‚³ã‚¹ãƒˆ(ã‚¢ãƒ¼ãƒãƒ¼)åˆ¤å®š
          if (pCard.cost > eCard.cost) {
            log(
              `ã‚ã„ã“(Cost ${pCard.cost} vs ${eCard.cost}) -> Playerã‚¢ãƒ¼ãƒãƒ¼å‹ã¡`
            );
            return applyDamage(player, enemy, pCard, pMod, "ã‚³ã‚¹ãƒˆå‹åˆ©");
          } else if (eCard.cost > pCard.cost) {
            log(
              `ã‚ã„ã“(Cost ${pCard.cost} vs ${eCard.cost}) -> Enemyã‚¢ãƒ¼ãƒãƒ¼å‹ã¡`
            );
            return applyDamage(enemy, player, eCard, eMod, "ã‚³ã‚¹ãƒˆå‹åˆ©");
          } else {
            // å®Œå…¨ç›¸æ®º
            log(`å®Œå…¨ç›¸æ®º (Cost ${pCard.cost}) - ä¸¡è€…å°ãƒ€ãƒ¡ãƒ¼ã‚¸`);
            player.hp -= 5;
            enemy.hp -= 5;
            return { winner: "draw" };
          }
        }
      }

      function applyDamage(attacker, defender, card, modifier, reason) {
        let dmg = 0;
        let postDmg = 0;

        switch (card.type) {
          case TYPES.ATTACK:
            dmg = DMG.MEDIUM;
            break;
          case TYPES.BREAK:
            postDmg = 20;
            dmg = 5;
            break; // ãƒ–ãƒ¬ã‚¤ã‚¯ã¯å§¿å‹¢ãƒ€ãƒ¡å¤§
          case TYPES.SP:
            dmg = DMG.SP;
            postDmg = 30;
            break;
          case TYPES.GUARD:
            // ã‚¬ãƒ¼ãƒ‰ã§å‹ã£ãŸå ´åˆ(ç›¸æ‰‹ãŒAttack): ãƒ€ãƒ¡ãƒ¼ã‚¸ç„¡åŠ¹ã€ã‚ã‚‹ã„ã¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ°—å‘³ã«ï¼Ÿ
            // ä»•æ§˜ã€ŒGuard > Attack: è¢«ãƒ€ãƒ¡æœ€å°é™ã€
            // æ”»æ’ƒå´ã¨ã—ã¦å‹ã£ãŸå ´åˆã©ã†ã™ã‚‹ã‹ï¼Ÿ -> ã“ã“ã§ã¯ãƒªã‚½ãƒ¼ã‚¹å›å¾©ç­‰ã®ãƒœãƒ¼ãƒŠã‚¹æ‰±ã„ã«ã™ã‚‹ã‹ã€è»½å¾®ãªåæ’ƒã¨ã™ã‚‹
            dmg = 5;
            break;
        }

        // ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆè£œæ­£
        if (defender.isBurnout) {
          dmg = Math.floor(dmg * 1.5);
          log(">> Burnoutã«ã¤ããƒ€ãƒ¡ãƒ¼ã‚¸1.5å€!", "log-dmg");
        }

        // ã‚¹ãƒ­ãƒƒãƒˆé€£é–è£œæ­£
        dmg = Math.floor(dmg * modifier);
        postDmg = Math.floor(postDmg * modifier);

        // é©ç”¨
        defender.hp -= dmg;
        defender.posture -= postDmg;

        log(
          `${attacker.name}ã®${card.name}ãŒãƒ’ãƒƒãƒˆ! (${reason}) HP-${dmg}, Posture-${postDmg}`,
          "log-dmg"
        );

        return { winner: attacker.isPlayer ? "player" : "enemy" };
      }

      function endTurnProcess() {
        // ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆåˆ¤å®š
        [player, enemy].forEach((f) => {
          if (f.ep <= 0) {
            f.isBurnout = true;
            log(`${f.name}ã¯åŠ›ã‚’ä½¿ã„æœãŸã—ãŸ... (BURNOUT)`, "log-sys");
          }
          // ãƒ–ãƒ¬ã‚¤ã‚¯åˆ¤å®š (å§¿å‹¢0) -> ä»•æ§˜æ›¸ã€Œ1ã‚¿ãƒ¼ãƒ³è¡Œå‹•ä¸èƒ½ã€ç­‰ã¯æ¬¡å›å®Ÿè£…ã€‚ä»Šå›ã¯HP/å§¿å‹¢ã®ã¿
          if (f.posture <= 0) {
            log(`${f.name}ã¯ä½“å‹¢ã‚’å´©ã—ãŸ! (BREAK)`, "log-sys");
            f.posture = 50; // ä»®å¾©å¸°
            // f.hp -= 20; // è¿½æ’ƒãƒ€ãƒ¡
          }

          // æ¬¡ã‚¿ãƒ¼ãƒ³æº–å‚™
          f.startTurn();
        });

        // çµ‚äº†åˆ¤å®š
        if (player.hp <= 0 || enemy.hp <= 0) {
          alert(player.hp <= 0 ? "YOU LOSE..." : "YOU WIN!");
          location.reload();
          return;
        }

        turnCount++;
        document.getElementById(
          "phase-display"
        ).innerText = `PHASE 1: Turn ${turnCount}`;

        updateUI();
      }

      // --- UIæç”» ---

      function updateUI() {
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        document.getElementById("p-hp").innerText = player.hp;
        document.getElementById("p-pos").innerText = player.posture;
        document.getElementById("p-ep").innerText = player.ep;
        document.getElementById("p-sp").innerText = player.sp;

        document.getElementById("e-hp").innerText = enemy.hp;
        document.getElementById("e-pos").innerText = enemy.posture;
        document.getElementById("e-ep").innerText = enemy.ep;
        document.getElementById("e-sp").innerText = enemy.sp;

        // ãƒãƒ¼ãƒ³ã‚¢ã‚¦ãƒˆè¡¨ç¤º
        document.getElementById("p-burnout-msg").style.display =
          player.isBurnout ? "block" : "none";
        document.getElementById("e-burnout-msg").style.display = enemy.isBurnout
          ? "block"
          : "none";

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ‰‹æœ­æç”»
        const pHandDiv = document.getElementById("player-hand-display");
        pHandDiv.innerHTML = "";

        player.hand.forEach((card, idx) => {
          const el = createCardEl(card);
          el.onclick = () => selectCard(idx);

          // é¸æŠçŠ¶æ…‹
          if (player.selectedCards.includes(card)) el.classList.add("selected");

          // ä½¿ç”¨ä¸å¯åˆ¤å®š
          let disabled = false;
          if (player.isBurnout && card.type === TYPES.GUARD) disabled = true;

          // é¸æŠã‚³ã‚¹ãƒˆè¨ˆç®—ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åæ˜ ã¯è¤‡é›‘ãªã®ã§ç°¡æ˜“çš„ã«ï¼‰
          // é¸æŠæ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã®åˆè¨ˆã‚³ã‚¹ãƒˆãŒç¾åœ¨EPã‚’è¶…ãˆãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å…¥ã‚Œã‚‹ã¨è¦ªåˆ‡

          if (disabled) el.classList.add("disabled");
          pHandDiv.appendChild(el);
        });

        // ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        const secSlot = document.getElementById("secret-slot");
        if (player.secretCard) {
          secSlot.style.opacity = 1;
          secSlot.onclick = () => selectSecret();
          if (player.selectedCards.includes(player.secretCard))
            secSlot.classList.add("selected");
          else secSlot.classList.remove("selected");
        } else {
          secSlot.style.opacity = 0.2;
          secSlot.onclick = null;
        }

        // æ•µæ‰‹æœ­æƒ…å ± (ä»•æ§˜: å±æ€§ã¨ã‚³ã‚¹ãƒˆã‚’å…¬é–‹)
        const eHandDiv = document.getElementById("enemy-hand-display");
        eHandDiv.innerHTML = "";
        enemy.hand.forEach((card) => {
          // æƒ…å ±ã®ã¿ã®ç°¡æ˜“ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
          const el = document.createElement("div");
          el.className = `card type-${card.type}`;
          el.style.width = "60px";
          el.style.height = "80px";
          el.innerHTML = `<div class="card-icon" style="font-size:1.5em">${
            ICONS[card.type]
          }</div><div style="font-size:0.8em">Cost ${card.cost}</div>`;
          eHandDiv.appendChild(el);
        });
        // æ•µã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ (ï¼Ÿè¡¨ç¤º)
        if (enemy.secretCard) {
          const el = document.createElement("div");
          el.className = `card type-Secret`;
          el.style.width = "60px";
          el.style.height = "80px";
          el.innerHTML = `<div class="card-icon">â“</div><div>Secret</div>`;
          eHandDiv.appendChild(el);
        }
      }

      function createCardEl(card) {
        const el = document.createElement("div");
        el.className = `card type-${card.type}`;
        el.innerHTML = `
        <span class="card-cost">${card.cost}</span>
        <div class="card-icon">${ICONS[card.type]}</div>
        <div class="card-name">${card.name}</div>
    `;
        return el;
      }

      function renderSlotResult(slotNum, result) {
        // ç”»é¢ä¸­å¤®ã®ã‚¹ãƒ­ãƒƒãƒˆã«çµæœã‚’è¡¨ç¤º
        const pCard = player.selectedCards[slotNum - 1];
        const eCard = enemy.selectedCards[slotNum - 1];

        const pSlot = document.getElementById(`p-slot${slotNum}`);
        const eSlot = document.getElementById(`e-slot${slotNum}`);

        // ã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        pSlot.innerHTML = "";
        pSlot.appendChild(createCardEl(pCard));
        eSlot.innerHTML = "";
        eSlot.appendChild(createCardEl(eCard));

        // å‹æ•—ãƒãƒƒã‚¸
        if (result.winner === "player") {
          pSlot.innerHTML += '<div class="slot-result win">WIN</div>';
          eSlot.innerHTML += '<div class="slot-result lose">LOSE</div>';
        } else if (result.winner === "enemy") {
          pSlot.innerHTML += '<div class="slot-result lose">LOSE</div>';
          eSlot.innerHTML += '<div class="slot-result win">WIN</div>';
        } else {
          pSlot.innerHTML += '<div class="slot-result draw">DRAW</div>';
          eSlot.innerHTML += '<div class="slot-result draw">DRAW</div>';
        }
      }

      // åˆæœŸåŒ–
      window.onload = initGame;
    </script>
  </body>
</html>
